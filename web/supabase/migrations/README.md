<!--- START SELFDOC --->
## SelfDoc
_Auto-generated code documentation to make the repository easier to navigate and contribute to._

_Last Updated: 2023-05-15_

The `migrations` directory is for managing changes to the Supabase database schema. It contains SQL scripts that create, alter, or drop tables, columns, constraints, policies, triggers, and indexes. These changes include adding new columns, tables, and views, setting default values, enabling row level security, and granting permissions to different roles. The directory also contains scripts that enable Supabase Realtime and create functions for inserting or updating data. The directory includes specific files that create or modify tables, views, and policies related to candidate and recruiter information, job interests, and job postings.

### Files
#### 20221111190519_init_schema.sql
This file creates tables for user email sync history and user OAuth tokens, along with policies and triggers to manage them. It also grants permissions to different roles and uses an extension called "moddatetime".

#### 20221125150334_add_examples_collected_at.sql
This file contains a SQL script that adds a new column called "examples_collected_at" to the "user_email_sync_history" table in the public schema. The script was generated by the Schema Diff utility in pgAdmin 4 and may require manual changes to ensure changes are applied in the correct order.

#### 20221201042714_oauth_token_is_valid.sql
This file contains a SQL script that adds a new column named "is_valid" to the "user_oauth_token" table in the "public" schema. The column is of type boolean and has a default value of true. The script was generated by the Schema Diff utility in pgAdmin 4.

#### 20221202024509_user_email_sync_history_synced_at.sql
This file contains a SQL script that adds a new column called "synced_at" to the "user_email_sync_history" table in the "public" schema. The column has a default value of the current timestamp with time zone. The script was generated by the Schema Diff utility in pgAdmin 4.

#### 20221206195808_user_waitlist_and_profile.sql
This file contains a SQL script that creates two tables, "user_profile" and "waitlist", with columns for user information and waitlist status. It also sets up policies and permissions for users to update, view, and manage their own profiles and waitlist entries. Additionally, it creates a trigger to update the "updated_at" column whenever a row is updated.

#### 20221216195906_non_null_dates.sql
This file contains SQL code that alters several tables in the Supabase database, setting certain columns to not allow null values.

#### 20221218000200_drop_examples_collected_at.sql
This file contains a SQL script that drops the `examples_collected_at` column from the `user_email_sync_history` table in the `public` schema. The script was generated by the Schema Diff utility in pgAdmin 4 and may require manual changes to ensure changes are applied in the correct order.

#### 20221218154035_add_user_profile_settings.sql
This file contains a SQL script that adds three new columns to the `user_profile` table in the `public` schema of the Supabase database. The new columns are `auto_archive`, `auto_contribute`, and `is_active`, all of which have default boolean values. The script was generated by the Schema Diff utility in pgAdmin 4.

#### 20221220010732_enable_realtime.sql
This file contains SQL code that enables Suapbase Realtime by dropping and recreating the `supabase_realtime` publication with no tables.

#### 20221220014041_user_email_stat.sql
This file contains SQL code that creates a table named `user_email_stat` with columns for user ID, email, statistics ID, and values. It also sets up foreign key constraints, row level security, and grants permissions to different roles. Additionally, it creates a policy that allows users to view their own email statistics and triggers to update the `updated_at` column. Finally, it adds the `USER_EMAIL_STAT` and `USER_EMAIL_SYNC_HISTORY` tables to the `SUPABASE_REALTIME` publication.

#### 20221220023058_increment_user_email_stat.sql
This file contains a SQL script that creates a function called `increment_user_email_stat`. The function takes in four parameters and inserts or updates data in the `public.user_email_stat` table based on the provided parameters. The script also grants execute permissions to various roles.

#### 20230110015803_cascade_user_delete.sql
This file contains a SQL script that drops and adds foreign key constraints for several tables in the public schema. The constraints reference the id column in the auth.users table and are set to cascade on delete. The script was manually created due to the automatic diff not picking up fkey changes.

#### 20230113205858_init_user_email_job.sql
This file contains a SQL script that creates a `user_email_job` table in the `public` schema with columns for job information and associated constraints and policies. Additionally, it creates a trigger for updating the `updated_at` field and adds the table to the `supabase_realtime` publication.

#### 20230209215223_init_recruiter.sql
This file initializes the database schema for the Shared Recruiting Co. platform by creating two tables, `company` and `recruiter`, and enabling row level security. It also sets up policies for recruiters to view and update their own profiles and companies, and for job management. Finally, it creates triggers to update the "updated_at" columns of the `recruiter` and `job` tables and grants permissions to various roles.

#### 20230210233849_oauth_token_views.sql
This file contains SQL code that creates two views: `recruiter_oauth_token` and `candidate_oauth_token`. These views join the `user_oauth_token` table with either the `recruiter` or `user_profile` table, respectively. The file also grants permissions to various roles for each view.

#### 20230216145636_multi_inbox_type_user_email_sync.sql
This file contains a SQL script that adds a new column called "email" to the "user_email_sync_history" table and creates a new enumerated type called "inbox_type" with two possible values: "candidate" and "recruiter". The script also adds a new column called "inbox_type" to the "user_email_sync_history" table with a default value of "candidate".

#### 20230218000412_multi_inbox_user_email_sync_pk.sql
This file contains a SQL script that drops and alters constraints and indexes for the "user_email_sync_history" table in the Supabase database, and creates a new unique index and primary key constraint.

#### 20230220235803_add_email_to_user_oauth_token.sql
This file contains a SQL migration script that adds an "email" column of data type text to the "user_oauth_token" table in the Supabase database.

#### 20230221003612_multi_email_user_oauth_token_pk.sql
This file contains SQL code that drops and alters constraints and indexes on the "user_oauth_token" table. It also creates two functions, "get_user_profile_by_email" and "get_recruiter_by_email", that return user profiles and recruiters based on email input.

#### 20230221145139_unique_email_provider.sql
This file creates a unique index on the `email` and `provider` columns of the `user_oauth_token` table in the `public` schema. It also adds a constraint to enforce the uniqueness of the index.

#### 20230222180617_recruiter_outbound_init.sql
This file initializes the `recruiter_outbound_message` and `recruiter_outbound_template` tables in the PostgreSQL database, along with their indexes and constraints. It also enables row level security for both tables, creates foreign key constraints, and sets policies and triggers related to recruiter outbound messages and templates in the Supabase database.

#### 20230223214413_security_invoker_for_views.sql
This file contains SQL code that recreates views on OAuth tokens with security invoker for candidate and recruiter users. The views select data from the user_oauth_token table and join it with either the user_profile or recruiter table based on the user type.

#### 20230224214941_candidate_company_inbound.sql
This file contains a SQL script that creates a table named "candidate_company_inbound" with various columns and constraints, enables row level security, and creates a unique index. It also contains functions, policies, and triggers related to the "candidate_company_inbound" table for inserting and updating data, updating job and template information, and handling user profiles and OAuth tokens.

#### 20230321020417_recruiter_email_settings.sql
This file contains a SQL migration script that adds a new column called "email_settings" to the "recruiter" table in the Supabase database. The column is of type jsonb and has a default value of an empty JSON object.

#### 20230323013250_candidate_count_views.sql
This file contains SQL code that creates two views: `outbound_template_recipient_count` and `job_candidate_count`. The first view calculates the number of unique recipients for each outbound message template, while the second view calculates the number of unique candidates for each job. Both views use the `security_invoker` option.

#### 20230327212631_candidate_job_count.sql
This file contains a SQL script that creates a view called "candidate_job_count" in the "public" schema. The view counts the number of distinct job IDs associated with each candidate ID in the "candidate_company_inbound" table, where the candidate ID is not null.

#### 20230328182921_vw_job_board.sql
This file contains a SQL script that creates or replaces a view called `vw_job_board` in the `public` schema. The view combines data from two tables (`candidate_company_inbound` and `user_email_job`) to display job information, including job title, company name, recruiter name and email, and whether the job is verified or not.

#### 20230403144517_allow_users_to_delete_jobs.sql
This file contains a SQL script that creates a policy allowing users to delete their own jobs in the "public"."user_email_job" table. The policy is permissive and uses the auth.uid() function to check if the user deleting the job is the same as the user who created it.

#### 20230407012943_candidate_job_count_unverified.sql
This file contains a SQL script that creates a view called `candidate_job_count_unverified` with the `security_invoker` option. The view selects the `user_id` and the count of distinct `job_id`s from the `user_email_job` table, grouped by `user_id`.

#### 20230407020555_candidate_job_interest.sql
This file contains a SQL script that creates a table called "candidate_job_interest" with columns for candidate ID, job ID, and job interest status. It also creates a unique index and foreign key constraints. The script is used to manage job interests for candidates on the Shared Recruiting Co. platform. Additionally, the file creates policies and a trigger for the "candidate_job_interest" table to allow candidates to update and view their own job interests and update the "updated_at" field whenever a row is updated. Finally, the file creates a view called "vw_job_board" that displays job postings and related information, including the candidate's job interest.

<!--- END SELFDOC --->