# db

`db` is a Go database client library for SRC. We use [sqlc](https://github.com/kyleconroy/sqlc) to auto-generate a SQL database client based off predefined queries.

We also manually maintain a http database client that leverages Supabase's auto-generated PostgREST API. In the future, we should be able to auto-generate the http client as well.

## Contributing

1. Install [sqlc](https://docs.sqlc.dev/en/stable/overview/install.html)

2. Write and name your query in `query.sql`

3. Re-generate the `/db` package

```bash
sqlc generate
```

4. Manually update the http client in `http.go`. For information on PostgREST's APIs, checkout their [documentation](https://postgrest.org/en/stable/).


<!--- START SELFDOC --->
## SelfDoc
_Auto-generated code documentation to make the repository easier to navigate and contribute to._

_Last Updated: 2023-05-15_

The `db` directory is for a Go database client library for SRC. It includes a package for interacting with a SQL database, functions for making HTTP requests to interact with the PostgREST API, several structs used to represent data in the SRC database, SQL queries for retrieving and updating user and OAuth token information, and SQL code to create and modify tables, policies, triggers, and functions related to various entities.

### Files
#### db.go
This file contains a Go package that provides an interface for interacting with a SQL database. It includes a struct `Queries` with prepared SQL statements for various database queries, as well as functions for executing SQL queries and closing prepared statements.

#### http.go
This file contains functions for making HTTP requests to interact with the PostgREST API, including fetching user profiles, OAuth tokens, and email jobs. It also includes functions for inserting and retrieving recruiter outbound messages and templates.

#### http_test.go
This file contains unit tests for the `db.HTTPQueries` struct, which implements the `db.Querier` interface. The tests include checking that the `NewHTTP` function correctly initializes the `HTTPQueries` struct, and that the `DoRequest` function correctly sends an HTTP request with the specified method, path, and input. Additionally, it contains a test function for the `db.NewHTTP` function that creates a mock HTTP server and tests the `db.DoRequest` function by making a request to the mock server and checking the response.

#### models.go
This file defines several structs used to represent data in the SRC database, including AuthUser, CandidateCompanyInbound, CandidateJobCount, CandidateJobCountUnverified, CandidateJobInterest, CandidateOauthToken, Company, Job, Recruiter, and RecruiterOutboundMessage. It also contains custom types and methods for scanning and handling null values for `InboxType` and `JobInterest` in the database.

#### querier.go
This file contains the `querier` package, which provides a `Querier` interface for executing SQL queries against a database. The interface includes methods for querying the database for recruiter and user email jobs, user profiles and OAuth tokens, and inserting recruiter outbound messages and templates. It is generated by `sqlc`, a tool for generating type-safe Go code from SQL.

#### query.sql
This file contains SQL queries for retrieving and updating user and OAuth token information, as well as various operations on email job and statistic tables, recruiter outbound message and template tables, and candidate job interest table. It includes queries for selecting, inserting, and deleting data, as well as upserting user OAuth tokens and email sync history.

#### query.sql.go
This file contains Go code that defines SQL queries and functions for querying and manipulating data in various tables of a PostgreSQL database, including `recruiter_outbound_message`, `user_profile`, `user_email_stat`, `user_email_sync_history`, and `user_oauth_token`. The functions take in parameters and return results based on the execution of the SQL queries.

#### schema.sql
This file contains SQL code to create and modify tables, policies, triggers, and functions related to various entities such as user profiles, recruiters, jobs, and candidate company inbound feature. It also includes views and types. The code enables row level security and real-time updates, restricts access to certain data based on user authentication status and role, and updates timestamps when rows are updated.

<!--- END SELFDOC --->